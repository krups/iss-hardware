\documentclass{article}
\usepackage[utf8]{inputenc}

\title{KREPE-2 Avionics Documentation}
\author{Matt Ruffner}
\date{}

\usepackage{url}
\usepackage{float}
\usepackage{tikz}
\usepackage{natbib}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{fullpage}
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
}

\begin{document}

\maketitle
\tableofcontents
\listoffigures
\listoftables
\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}

This document contains information about the flight computer for the KREPE-2 mission as well as the safety precautions taken to ensure the flight hardware is not a danger to the ISS or its astronauts. In addition to electrical designs and schematics, this document contains pin names, links to datasheets, and implementation notes. The following sections outline the subsystems of the flight computer and pin names for software usage. Other details about the power subsystem including battery type and rating are also included. 

There are a total of 5 capsules in the KREPE-2 mission, an increase from the 3 capsules present in the original KREPE mission (now referred to as KREPE-1). The table below shows the part names and numbers of the 5 capsules as presented to NASA for integration with a resupply mission.

\begin{table}[H]
\centering
\caption{Part names and numbers for the KREPE-2 capsules.}
\label{tab:partnames}
\begin{tabular}{l | l}
Part Name & Part Number \\
\hline
KRUPS-LI2200 & KRUPS-001 \\
KRUPS-AMTPS & KRUPS-002 \\
KRUPS-CPICA & KRUPS-003 \\
KRUPS-FBRFRM & KRUPS-004 \\
KRUPS-REUSE & KRUPS-005 
\end{tabular}
\end{table}

The entire flight ready assembly is referred to as KREPE, which consists of a capsule containing the science (flight computer, batteries, etc.) and a metal shell known as KREM that acts as a Faraday cage, inhibiting any inadvertent RF radiation from the capsule. Both primary and secondary activation must occur for the capsule to become fully active and begin RF transmissions. To avoid accidental activation of hazardous subsystems, secondary activation criteria must be met. Primary and secondary activation processes are discussed in sections ~\ref{sec:primary-activation},\ref{sec:secondary-activation}, and \ref{sec:radio-power-control}.

The subsystems of the flight computer are outlined in Sec.~\ref{sec:subsystems}. Pin definitions are listed with each hardware or sensor component along with any relevant information regarding safety or implementation. Electrical schematics, microcontroller reference cards, and a partslist are shown in  Appendices ~\ref{appa}, \ref{app:pinmap}, and \ref{app:partslist}, respectively.


\subsection{Primary Activation}
\label{sec:primary-activation}

\begin{tikzpicture}[
   every node/.append style={circle, draw=blue!80, inner sep=0pt, minimum size=12pt}]
\node                 (1) at (0,0) {1};
\node[thick]          (2) at (1,0) {2};
\node[draw=white,text=black] (...) at (2,0) {...};
\end{tikzpicture}

Primary activation is triggered by a pin pulled out of KREPE by astronauts. Once the pin is pulled, a mechanical switch\footnote{\url{https://www.digikey.com/en/products/detail/panasonic-electric-works/ABJ362860/4691828}} is closed and the flight computer boots to dormant mode where it consumes minimal power. The Iridium radio is not powered on in dormant mode. After pulling the pull tab, an astronaut places a piece of copper tape over the hole, resealing the faraday cage effect of the KREM, and primary activation is the complete. Copper tape ensures the KREM is completely sealed with regard to inadvertent EMI while on station.

A schematic showing battery protection and primary activation circuitry activation is shown in Fig. \ref{fig:activation-circuitry}. Less than 5 inches of copper 20 AWG PVC insulated wire is used to connect the batteries to the first power function (battery protection circuitry).


%The \texttt{POWER\_SW} header must closed for protected battery or USB voltage to be applied to the Teensy's VIN pin, powering on the system. The location of these connection points can be seen in Fig. \ref{fig:board-top} labelled on the silk screen in the left middle of the PCB. A rendering of the bottom of the board is shown in Fig. \ref{fig:board-bottom}.


\begin{figure}[H]
    \centering
    \includegraphics[width=12cm]{images/krepe2-avionics.png}
    \caption{Activation and battery protection schematic overview.}
    \label{fig:activation-circuitry}
\end{figure}



%There is an low power 915MHz ISM band debug communication link that is only used during testing on the ground and is physically disconnected from power before once handed over for final integration. The \texttt{ISM\_SW} header is meant to enable and disable the RFM69 debug radio. The center 3.3V pin of this header is connected to the normally closed labeled pin, a GPIO pin is pulled high (see Fig. \ref{tab:pins_radio}). When the normally closed pin is connected to the center pin, the RFM69 is enabled. 




\subsection{Secondary Activation}
\label{sec:secondary-activation}
Once primary activation is complete and the flight computer is in dormant mode, a digital input to the flight computer is configured as an interrupt to sense when the KREM separates from around the capsule. This secondary activation interrupt is triggered during re-entry when the KREM heats to a temperature that is sufficient to melt the polycarbonate bolts that hold it together. No radio transmissions are attempted before secondary activation. The Iridium radio remains unpowered until secondary activation.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Subsystem Design}
\label{sec:subsystems}

The following sections outline the different sensor systems that are present on the KREPE-2 capsules, including their placement along the forebody and relative position to other sensors. 

\begin{figure}
\centering
\includegraphics[width=5cm]{images/tps_cad_highlight}
\label{fig:sensor-locations}
\caption{Thermal, pressure, and spectral measurement location on the capsule forebody.}
\end{figure}

\subsection{Thermal Measurement}
The thermal measurement subsystem is used to take readings from up to six thermocouples (TCs) embedded within the TPS surrounding each capsule. 

The thermocouple to digital conversion system on KREPE-2 uses 6 MCP-9600 TC to digital converters linked via I2C bus. This is an improvement over the multiplexed converter setup used in the first KREPE mission. A low pass filter is included between the TC connector points and each MCP-9600 to help suppress spurious measurements.
%%
%\begin{figure}[H]
%  \centering
%    \includegraphics[width=0.5\textwidth]{images/krepe2-tc-closeup}
 %   \caption{TC connection points for three of the six TC to digital conversion chips on the KREPE- flight computer. The plated holes accept solderable threaded inserts which make connecting TC lead wires much easier compare to the KREPE-1 flight computer, which required TC leads to be crimped into a Molex PicoBlade connector.}
%    \label{fig:tc-closeup}
%\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Pressure Measurement}
The KREPE-2 capsule design includes an array of ported pressure sensors in a cross configuration, constitutes what is known as a flushed air data sensing (FADS) system. Such FADS systems are very useful in the reconstruction of the re-entry trajectory attitude\cite{TODO}. Flexible PTFE tubing is used  to connect the hole in the forebody to the barb on the pressure sensor. An image of the Honeywell sensor used is shown in Fig. \ref{fig:pressure-sensor}.

\begin{figure}[H]
\centering
\includegraphics[width=3cm]{images/honeywell-sensor}
\caption{Honeywell ported pressure sensor used for the FADS system. }
\label{fig:pressure-sensor}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Spectrometer Subsystem}
Another addition to the sensor suite on the KREPE-2 capsules is a Hamamatsu C12880 miniature spectrometer\footnote{\url{https://www.hamamatsu.com/content/dam/hamamatsu-photonics/sites/documents/99_SALES_LIBRARY/ssd/c12880ma_kacc1226e.pdf}}.

Due to the position that the spectrometer must be in, in the nose (stagnation point) of the capsule, there is a need for a processing element in the same region. For this reason we are working on implementing a Battery and Spectrometer Measurement System (BSMS). This BSMS will be able to read the spectrometer as well as monitor the system battery voltages. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Inertial Measurement}
The KREPE-2 flight computer also features multiple inertial measurement sensors to collect rotational rates and accelerations experienced by the capsule during re-entry. Like FADS measurements, the IMU data collected by the capsule will also greatly aid the post-flight reconstruction of the re-entry environment which occurred for each capsule.

The inertial sensors present on the KREPE-2 flight computer are an FSM300, ICM-42670, and an H3LIS100. The FSM300 is a preassembled unit which features a BNO-088 9 axis IMU. The maximum acceleration measurable by the FSM300 is $\pm$16g. The ICM-42670 is an additional 6-axis IMU included as an evaluation platform. The primary IMU is the FSM300. The H3LIS100 is a 3-axis accelerometer, included for measuring accelerations on the capsule which are greater than $\pm$16g.

%\paragraph{Barometric Pressure Sensor}
%Version 1.1 of the flight computer features an Infineon DSP310 barometric pressure and temperature sensor connected to the SPI bus with active low chip select on pin 8 of the Teensy. This sensor is not used for activation detection. 



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%55
\subsection{Power and Batteries}

The power and battery subsystem on the KREPE-2 capsules has improved features and capacity from the KREPE-1 design. Batteries are still provided by NASA Cargo Mission Contract (CMC) fulfilled by JSC and rated at 3200mAh each. KREPE-2 features two separate battery packs which allow for greater flexibility when designing any future capsule instrumentation. Three cells are tabbed in series to provide a 3S1P pack (11.1V nominal), as well as a secondary system pack which consists of 3 cells tabbed in parallel, or 1S3P. %The 1S3P (3.7V nominal) pack is an improvement over the 1S2P pack of KREPE-1 which powered the entire system.

The 3.7V pack powers the flight computer, but not any high-draw peripherals (GPS, Iridium modem, spectrometer, etc). The 11.1V pack is switched on after secondary activation and powers any high draw peripherals through an optional 5V buck regulator. 

Battery classification, product, and model number can be seen in Fig. \ref{fig:bat-spec} (taken from battery specification sheet).

\begin{figure}[h!]
	\centering
	\includegraphics[width=12cm]{images/battery-spec.png}
	\label{fig:bat-spec}
	\caption{Sanyo battery specifications from the datasheet.}
\end{figure}

The 3.7 pack is able to be recharged through the MCP73831\footnote{ (\url{https://www.microchip.com/wwwproducts/en/MCP73831})} present on the Feather M4, however the 11.1V pack currently be charged externally through a separate balance connector which does not connect to the flight computer.  

There is work ongoing which aims to support the monitoring of the 3S1P pack. This system will also interface with the spectrometer. 

Charging is only performed on the ground and there is no provision for charging in flight. Schematics and electrical connections are shown in Fig. \ref{fig:page1-3} in Appendix \ref{appa}.

\subsubsection{Battery Status Interface}
Throught BSMS...

\subsubsection{Battery Protection}
Protection circuitry is implemented on each of the two battery packs present on the KREPE-2 capsules. 

 We are using a DW01-P Voltage and Current Protection IC for the 3.7V system pack  \footnote{\url{https://cdn.sparkfun.com/assets/learn_tutorials/2/5/1/DW01-P_DataSheet_V10.pdf}}.

The 11.1V auxiliary pack has a separate battery protection circuit that protects it from over current, under voltage, and over voltage conditions.

TODO: add in the circuit and chip used on the 11.1V pack and add in the oscilloscope trace for it protecting from over current. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\textwidth]{images/dw108.png}
	\caption{Battery protection circuitry.}
	\label{fig:bat-protec}
\end{figure}



Protection circuitry as implemented on the KREPE flight computer PCB is shown in Fig. \ref{fig:bat-protec}. Our two battery packs are both connected to their respective battery protection circuitry, then  to primary activation switches. This protection circuitry is upstream of the primary activation switch. The battery protection PCB can be seen in Fig. \ref{fig:bat-protect}.



\begin{figure}[H]
	\centering
	\includegraphics[width=0.5\textwidth]{images/new_batt_prot.png}
	\caption{Battery protection PCB.}
	\label{fig:bat-protect}
\end{figure}


\paragraph{Over-current protection}
Need to update this document with new o-scope traces of the battery protection circuitry kicking in and cutting current draw to zero.


\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{images/over-current.png}
	\caption{The battery protection circuity disconnecting the cells after 6ms of over current condition. Blue: current. Purple: pack voltage.}
	\label{fig:over-current}
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Visual Status Indicators}
There are individual LEDs on the POL switches connected to each serial port header, in addition to an indicator on the external 3v3 regulator. In addition to these indicators, the Feather M4 board also has an RGB led that is used to indicate program state



\section{Board Configuration and Programming}

\subsection{Solder Jumpers}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% APPENDIX
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix


\section{Schematics}
\label{appa}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/flight-computer-schematic-page1.pdf}
    \caption{Page one of schematics.}
    \label{fig:page1-2}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/flight-computer-schematic-page2.pdf}
    \caption{Page two of schematics.}
    \label{fig:page1_1}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/flight-computer-schematic-page3.pdf}
    \caption{Page three of schematics.}
    \label{fig:page1-3}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/flight-computer-schematic-page4.pdf}
    \caption{Page four of schematics.}
    \label{fig:page1-4}
\end{figure}


%\begin{figure}[H]
%    \centering
%    \includegraphics[width=\textwidth]{images/page5.png}
%    \caption{Page five of schematics.}
%    \label{fig:page1-5}
%\end{figure}

\section{Board Renderings}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{images/main_board-top.png}
	\caption{Rendering of the top of the KREPE-2 control board.}
	\label{fig:board-top}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{images/main_board-bottom.png}
	\caption{Rendering of the bottom of the KREPE-2 control board.}
	\label{fig:board-bottom}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
\section{COTS hardware references}
This section contains reference cards for the COTS components used in the KREPE-2 capsules.
\subsection{Feather M4 Express}
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/featherm4pinout.png}
    \caption{Feather M4 Express}
    \label{fig:teensy-front}
\end{figure}

\subsection{Nano Pi Neo Air}
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/neo air pinout.jpeg}
    \caption{NanoPi Neo Air reference sheet.}
    \label{fig:trinket-m0}
\end{figure}


\section{Partslist}
\label{app:partslist}
\lstinputlisting[language={},basicstyle=\tiny]{flight-computer-partslist.txt}

%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% TODO: replace with FeatherM4 pin mapping
\newpage
\section{Arduino Pin Mapping}
\label{app:pinmap}
\lstinputlisting[language={}]{arduino-pinmap.txt}

%\bibliographystyle{plain}
%\bibliography{references}
\end{document}
