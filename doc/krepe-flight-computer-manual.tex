\documentclass{article}
\usepackage[utf8]{inputenc}

\title{KREPE Flight Computer Hardware Manual}
\author{Matt Ruffner}
\date{July 10, 2020}

\usepackage{url}
\usepackage{float}
\usepackage{natbib}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{fullpage}
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
}

\begin{document}

\maketitle
\tableofcontents
\newpage
\listoffigures
\listoftables
\newpage

\section{Introduction}

This document has pin names and connections, along with implementation notes and design choice explanations. Schematic designs for this board were adapted from previous designs of KRUPS projects here at the University of Kentucky. Battery charging, improved activation circuitry, a newer IMU, and wireless debug capability are the main additions to previous designs. Newer thermocouple conversion ICs were also added to replace the EOL product that was in previous designs. Activation subsytems and criteria are also outlined.

The following sections outline the electrical connections for control of the board w.r.t. the Teensy 3.5 microcontroller, as well as several relevant subsystem specifications and links to datasheets. Charging and switch wiring for activation are also explained. Schematics are in Appendix \ref{appa}, along with Teensy 3.5 reference card images.

\subsection{Primary Activation}
Primary activation is triggered by a pin pull out the KREPE enclosure performed by astronauts. Once the pin is pulled, the flight computer is powered on and in standy mode, consuming a minimal amount of power. No radios are powered on in standy mode to ensure no interference with ISS activities. 

The \texttt{POWER\_SW} header must closed for protected battery or USB voltage to be applied to the Teensy's VIN pin, powering on the system. The location of these connection points can be seen in Fig. \ref{fig:board-top} labelled on the silk screen in the left middle of the PCB. A rendering of the bottom of the board is shown in Fig. \ref{fig:board-bottom}.

An end-to-end schematic showing battery protection and device activation is shown in Fig. \ref{fig:activation-circuitry}. 20 AWG non silicone insulated wire of length less than 5 inches is used to connect the batteries to the first power function (battery protection circuitry).

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/krepe-electrical-overview.png}
    \caption{Activation and battery protection schematic overview.}
    \label{fig:activation-circuitry}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/krepe-top.png}
    \caption{Rendering of the top of the KREPE control board, V1.1.}
    \label{fig:board-top}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/krepe-bottom.png}
    \caption{Rendering of the bottom of the KREPE control board, V1.1.}
    \label{fig:board-bottom}
\end{figure}

The \texttt{ISM\_SW} header is meant to enable and disable the RFM69 debug radio. The center 3.3V pin of this header is connected to the normally closed labeled pin, a GPIO pin is pulled high (see Fig. \ref{tab:pins_radio}). When the normally closed pin is connected to the center pin, the RFM69 is enabled. This way, debug communication can be used while testing in a way that also ensures it will be off when on a live mission. This radio is only used for ground testing communication purposes, and once handed over for final integration, will never be enabled or able to receive power. These\footnote{\url{https://www.digikey.com/product-detail/en/omron-electronics-inc-emc-div/D2SW-3L1H/Z12268-ND/1811989}} are the switches used for the pin pull activation.




\subsection{Secondary Activation}
Once primary activation is complete and the flight computer is in standby mode, sensors are polled to check for conditions necessary for secondary activation. Secondary activation is software based and only engaged once the KREPE probe has separated from its protective metal enclosure. No radio transmissions are attempted before secondary activation. 

Thermocouples and the capacitive sensing subsystem are polled to check for conditions sufficient for secondary activation. A heating of the metal KREPE enclosure is necessary to melt the plastic bolts that hold it together. This ambient temperature increase of the probe is the primary criteria for secondary activation. The presence of this metal enclosure is also detected by capacitive sensors on the KREPE probe. Once the thermal and capacitive sensing subsystems have detected the separation of the metal enclosure, the Iridium radio is powered on and packet transmission begins.  

An activation redundancy processor (ARP) was added in Rev. 1.1 of the flight computer, if the flight computer needs to be tested without the ARP, there is a solder jumper on the bottom of the PCB (SJ1) that, when shorted together, bypasses the AND gate that controls Iridium radio activation, reducing the system to single activation.

\section{Activation Redundancy Processor}
\label{actred}
Revision 1.1 of the KREPE flight computer adds a SAMD21 Cortex-M0 safety processor to also monitor the status and reading of all thermocouples onboard the KREPE capsule. Section \ref{actred} discusses this more. An overview of the secondary activation redundancy this safety processor provides is shown in Fig. \ref{fig:actred}.

With the ARP in place, there are two separate CBCS in place in the KREPE capsule, meaning that an erroneous act from one CBCS is not sufficient to activate the iridium radio. 

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{images/redundant-activation.png}
  \caption{Secondary activation rendundancy provided by the safety processor.}
  \label{fig:actred}
\end{figure}

\subsection{Bootloading the ARP}
The SAMD21 must be flashed with the UF2 bootloader \url{https://learn.adafruit.com/programming-microcontrollers-using-openocd-on-raspberry-pi}.

show picture of header for programming, reset pin, swclk, swdio pins. 
\subsection{Programming the ARP}
The microUSB port next to the ARP (CN1) is used to upload program flash using the Arduino IDE. This is only possible once the bootloader has been flashed with OpenOCD.

\subsection{ARP Hardware Connections}
Show which pins connect into the SPI bus and which goes to the AND gate for iridium activation.

\section{Subsystems}

\subsection{Status and Error Indicators}
\begin{table}[H]
    \centering
    \begin{tabular}{c|c|c}
    Teensy Pin & Net Name     & Teensy Configuration \\
    \hline 
    3 & LED1 - IRIDIUM ON        &   \texttt{OUTPUT}\\
    4 & LED2 - IRIDIUM SIGNAL OK       &   \texttt{OUTPUT}\\
    5 & LED3 - IRIDIUM RADIO TRANSMITTING       &   \texttt{OUTPUT}\\
    6 & LED4 - ISM RADIO TRANSMITTING       &   \texttt{OUTPUT}\\
    7 & LED5 - GENERAL ACTIVITY       &   \texttt{OUTPUT}
    \end{tabular}
    \caption{Debug LED Connections.}
    \label{tab:pins_leds}
\end{table}

\subsection{Serial Interface Signals}

\begin{table}[H]
    \centering
    \begin{tabular}{l|l|c}
   Teensy Pin & Net Name &  Description \\
    \hline \hline
    
        \hline
    13 & SCLK     &  SPI Clock \\
    12 & MISO     &  Master In Subject Out \\
    11 & MOSI     &  Master Out Subject In \\
    20 & CS@TC1 & MAX31856 chip select, active low \\
    21 & CS@TC2 & MAX31856 chip select, active low  \\
    9 & CS\_ISM     & RFM69 chip select, active low  \\
    \hline
    32 & TIRI     & Iridium TX UART \\
    31 & RIRI      & Iridium RX UART \\
    \hline
    19 & SCL & I$^2$C bus clock \\
    18 & SDA & I$^2$C bus data
    \end{tabular}
    \caption{Pins used with SPI, I$^2$C, and UART interfaces.}
    \label{tab:pins_serial}
\end{table}

\subsection{RFM69 Radio}
Note that this radio is not supplied with power unless the \texttt{NO} to \texttt{C} connection is made on the \texttt{ISM\_SW} header (see Fig. \ref{fig:board-top}).  Maximum output power according to the radio datasheet (\url{https://cdn.sparkfun.com/datasheets/Wireless/General/RFM69HCW-V1.1.pdf}) is 100mW.
\begin{table}[H]
    \centering
    \begin{tabular}{c|c|c|r}
    Teensy Pin & Net Name  & Description   & Teensy Configuration \\
    \hline 
    28 & RESET\_ISM  &  Pull low to enable RFM69   & \texttt{OUTPUT} \\
    29 & INT\_ISM    &  GPIO0 interrupt from RFM69 & \texttt{INPUT} \\
    33 & RADIO\_OFF\_SIG & Pulled high when the RFM69 is disabled & \texttt{INPUT} \\
    \end{tabular}
    \caption{Radio module interface signals.}
    \label{tab:pins_radio}
\end{table}
The datasheet for this antenna can be found at  \url{https://cdn.taoglas.com/datasheets/FXP290.07.0100A.pdf}. 

\subsection{Iriduim Radio}
We are using the A3LA-RS type modem seen on the NAL Research site (\url{http://www.nalresearch.com/IridiumHardware.html}). The RF specifications, taken from the module's datasheet are shown in Fig. \ref{fig:iridium-rf-specs}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{images/iridium-rf-specs.png}
    \caption{RF specifications of the AL3A-RS Iridium modem.}
    \label{fig:iridium-rf-specs}
\end{figure}
  
\subsubsection{Radio Power Control}
This is the partial activation source for the Iridium radio. Rev. 1.1 the flight computer features a secondary safety processor to continually monitor the thermocouple measurement circuits in parallel with the Teensy. An AND gate controls the power to the solid state relay controlling power to the Iridium radio. THe secondary processor is connected to the other input of this AND gate to make sure that erroneous action on behalf the teensy (or secondary safety processor) is not able to solely activate the radio. 

The following table shows the pin from the Teensy that activates the solid state relay controlling power to the Iridium radio.
\begin{table}[H]
    \centering
    \begin{tabular}{l|l|c|r}
   Teensy Pin & Net Name     &  Description  & Teensy Configuration \\
    \hline
    23 & PRI\_ACT   & Primary Iridium activation, active high & \texttt{OUTPUT} 
    \end{tabular}
    \caption{Pin controlling power to the iridium satellite radio.}
    \label{tab:pins-iridium}
\end{table}

\subsection{Thermocouple Measurement Interface}
Note: this board features an update thermocouple interface IC than the previous boards. Among other enhancements it allows for broader temperature range reading and improved precision.
\begin{table}[H]
    \centering
    \begin{tabular}{c|c|c|r}
    Teensy Pin & Net Name  & Description   & Teensy Configuration \\
    \hline 
    16 & MUX0 & MUX select pin 0 & \texttt{OUTPUT} \\
    17 & MUX1 & MUX select pin 1 & \texttt{OUTPUT} \\
    25 & TC1\_FAULT & U13 fault (active low) & \texttt{INPUT} \\
    26 & TC2\_FAULT & U12 fault (active low) & \texttt{INPUT} \\ 
    \end{tabular}
    \caption{Analog mux selection and thermocouple fault status pins.}
    \label{tab:pins_thermo}
\end{table}

\subsubsection{Thermocouple Connections}
The 8 thermocouple connections are done with 2 analog multiplexers IC1 and IC3 (MUX1 and MUX2). The MUX select pins go to both of these chips to select a certain channel. The table of MUX(0/1) select values versus two selected thermocouples are shown in Table \ref{tab:tc-mux-sel}.

\begin{table}[H]
  \centering
  \begin{tabular}{c | c | c}
    MUX0 & MUX1 & TC number \\
    \hline
    0 & 0 & 1, 5 \\
    0 & 1 & 2, 6 \\
    1 & 0 & 3, 7 \\
    1 & 1 & 4, 8
  \end{tabular}
  \caption{Truth table for multiplexer select pins and their relation to the pairs of thermocouples that are selected.}
  \label{tab:tc-mux-sel}
\end{table}
%
Pin connections on headers P1 and P2 show the connections for TC 1-8 lead wire pairs. Figure \ref{fig:tc-conn} shows the pinout on the silkscreen.
%
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{images/krepe-thermocouples.png}
    \caption{Thermocouple connection wiring with resepect to the analog mux chips IC3 (MUX2) and IC1 (MUX1).}
    \label{fig:tc-conn}
\end{figure}


\subsection{Barometric Pressure Sensor Connections}
Version 1.1 of the flight computer features an Infineon DSP310 barometric pressure and temperature sensor connected to the SPI bus with active low chip select on pin 8 of the teensy.


\subsection{Motion Sensor Connections}

\begin{table}[H]
    \centering
    \begin{tabular}{c|c|c|r}
    Teensy Pin & Net Name  & Description   & Teensy Configuration \\
    \hline 
    36 A17 & XOUT & Analog out from accel (x axis) & \texttt{INPUT} \\
    37 A18 & YOUT & Analog out from accel (y axis) & \texttt{INPUT} \\
    38 A19 & ZOUT & Analog out from accel (z axis) & \texttt{INPUT} \\
    35 & INT & Interrupt from ICM-20948 & \texttt{INPUT} \\
    34 & FSYNC & Synchronization signal to ICM-20948 & \texttt{OUTPUT} 
    \end{tabular}
    \caption{Pins connecting to the ADXL377 and ICM-20948.}
    \label{tab:pins_motionsensor}
\end{table}



\subsection{Charging and Power}

Charge current is limited to to 450 mA. Charge power can be delivered via Teensy USB or the \texttt{CHARGE} header. Charging input voltage is expected to be 5 volts.

For battery protection, the adafruit batteries we use (\url{https://www.adafruit.com/product/354}) have built in protection circuitry. Charge management is handled by an MCP73831 IC (\url{https://www.microchip.com/wwwproducts/en/MCP73831}), with status connections to the Teensy as shown in Table \ref{tab:pins-battery}. Schematics and electrical connections are shown in Fig. \ref{fig:page1-3} in Appendix \ref{appa}.

\subsubsection{Battery Status Interface}
\begin{table}[H]
    \centering
    \begin{tabular}{c|c|c|r}
    Teensy Pin & Net Name  & Description   & Teensy Configuration \\
    \hline 
    14 & BAT\_STAT & LiPo charge state & \texttt{OUTPUT} \\
    22 A8 & BAT\_SENSE    &  Halved battery voltage for monitoring &   \texttt{INPUT} 
    \end{tabular}
    \caption{Pins to monitor battery voltage and charging status.}
    \label{tab:pins-battery}
\end{table}

\subsubsection{Battery Protection}
Protection circuitry is implemented on the flight board to support 2P1S LiPo packs for system power. We are using a TI BQ2970 Voltage and Current Protection IC (\url{ http://www.ti.com/lit/ds/symlink/bq2970.pdf}). Protection circuitry as implemented on the KREPE flight computer PCB is shown in Fig. \ref{fig:bat-protec}.  Cell+ and Cell- attach to the battery pack and Pack+/Pack- face system power. This protection circuitry is upstream of the primary activation switch.

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/battery_protection_schematic.png}
    \caption{Battery protection circuitry.}
    \label{fig:bat-protec}
\end{figure}

Renderings of the bottom and top of the battery protection PCB can be seen in Figs \ref{fig:bat-top} and \ref{fig:bat-bottom}.


\begin{figure}[H]
    \centering
    \includegraphics[width=0.3\textwidth]{images/BatteryProtection-render-top.png}
    \caption{Rendering of the top of the battery protection PCB.}
    \label{fig:bat-top}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=0.3\textwidth]{images/BatteryProtection-render-top.png}
    \caption{Rendering of the bottom of the battery protection PCB.}
    \label{fig:bat-bottom}
\end{figure}

%\section{Testing Software}

%ICM-20948 testing software is functional. ADXL377 test software is functional. Lipo charge circuitry is functional. Need to test thermocouple hardware still.

%TODO: simple sketch that tests a newly assembled board to make sure the IMU, accel, debug radio, iridium radio and thermocouple amplifiers are working as expected. 

























%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  APPENDIX
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix


\section{Schematics}
\label{appa}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/page1.png}
    \caption{Page one of schematics.}
    \label{fig:page1-2}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/page2.png}
    \caption{Page two of schematics.}
    \label{fig:page1_1}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/page3.png}
    \caption{Page three of schematics.}
    \label{fig:page1-3}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/page4.png}
    \caption{Page four of schematics.}
    \label{fig:page1-4}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/page5.png}
    \caption{Page five of schematics.}
    \label{fig:page1-5}
\end{figure}


\section{Teensy 3.5 Reference}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/card8a_rev2.pdf}
    \caption{Teensy 3.5 Front}
    \label{fig:teensy-front}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/card8b_rev2.pdf}
    \caption{Teensy 3.5 Back}
    \label{fig:teensy-back}
\end{figure}


\newpage

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{images/trinket-m0.png}
    \caption{Trinket-M0 Arduino Reference (for ARP chip).}
    \label{fig:trinket-m0}
\end{figure}


\section{Partslist}
\label{app:partslist}
\lstinputlisting[language={},basicstyle=\tiny]{flight-computer-partslist.txt}

\newpage
\section{Arduino Pin Mapping}
\label{app:pinmap}
\lstinputlisting[language={}]{arduino-pinmap.txt}


%% CBCS compliance
\newpage
\section{General Requirements Compliance}
Upon both power up (after primary activation via pull-tab) and detection of a termination or off-nominal power condition, the Teensy processor will enter a safe reset state, where all GPIO pins controlling critical system functions are set to a high impedance value. This high impedance state, in addition to the flight computer PCB, ensure requirements in the \textit{General Requirements for the Computer-Based Control System Safety Requirements for the ISS} are met. Overcurrent and undervoltage protection for battery cells is implemented upstream of the flight computer, limiting the off-nominal power conditions expected (see KREPE Flight Computer Hardware Manual). See Fig. \ref{fig:exec-lifecycle} for an overview of the main execution lifecycle and how upon both power up and detection of an abnormal power condition both put the CBCS back into the safe high impedance state. CBCS General Requirements are discussed below.

\subsection{Req. 3.1.1.1}
Teensy 3.5 controller documentation shows that the controller powers up into the known safe reset state. No outputs occur until the processing state is initiated (see Fig. \ref{fig:exec-lifecycle}). Verification for this requirement will monitor the state of Teensy output pins with external hardware upon power up to make sure specific signals (i.e. iridium soli state relay activation signal) do not transition unexpectedly. 

\subsection{Req. 3.1.1.2}
KREPE flight computer software on the Teensy 3.5 controller enters a safe state in the event that a termination condition is detected (e.g. low system battery  voltage; see Fig. \ref{fig:exec-lifecycle}). As the KREPE capsule is incapable of receiving any external commands, the detection of a termination command scenario is not applicable. Testing for compliance with this requirement entails monitoring of Flight computer pin state with external hardware while the system experiences low battery voltage to make sure it places critical pins in a high impedance or off state.

\subsection{Req. 3.1.1.3}
The KREPE battery protection subsystem prevents any overcurrent or undervoltage conditions from reaching the flight computer. The main off-nominal power condition the flight computer may encounter is power failure. The Teensy 3.5 controller features a power management controller that will place it in a safe reset state if a power failure is detected. The KREPE flight computer also  monitors system battery voltage to preemtively detect an off-nominal power condition and place the system in the safe state (see Fig. \ref{fig:exec-lifecycle}).

Testing of all flown cells will be done including full charge/discharging cycling, under-voltage, over-voltage, and over-current testing with the battery protection circuitry in place. Analysis will be performed via debug interface and external hardware to make sure the flight computer returns to the prescribed safe reset state upon recovery from these off-nominal power conditions.

\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{images/software-overview.png}
  \caption{Overview of main execution cycle showing return to safe high-Z reset state upon startup and abnormal power condition.}
  \label{fig:exec-lifecycle}
\end{figure}

\subsection{3.1.1.4}
N/A

\subsection{3.1.1.5}
N/A

\subsection{3.1.1.6}
The metal enclosure that houses the KREPE module acts as a Faraday cage and mitigates the risk imposed to the CBCS by inadvertent memory modification.
Inspection
See 3.1.1.4
Suggest putting a transmitter inside and see if we can detect any leakage at MSFC if possible.
\subsection{3.1.1.7}
Upon detection of an anomaly internal to the CBCS there is watchdog timer functionality that will return the CBCS to the known safe initialization state. Verification procedures for this requirement entail physical disruption/disconnection of flight computer hardware to ensure control software can recover.

\subsection{3.1.1.8}
The external sources in this case would be the ambient temperature of capsule and the presence of the metal enclosure around the KREPE capsule. The capsule uses the Fault flags on the thermocouple to digital converter are used to discern if a valid thermocouple reading has been collected or not. There are also multiple thermocouples whos values are cross checked for consistency in valid readings. Capacitive sensing is also used to detect the presence of the metal enclosure around the KREPE capsule. Both of these inputs are used to discern between valid and invalid input.

Verification for this requirement entails physical disconnection/perturbation of thermocouple and capacitive sensing leads to analyze the induced effect on measurement values and fault conditions. 

\subsection{3.1.1.9}
Inspection
Inspection of software code verifies all lines of code are traceable to system or software requirements.
Test
Coverage analysis of flight code will ensure lack of dead code and all system software acts for a requirement.
See Fig. \ref{fig:exec-lifecycle} for KREPE software design requirements.

\subsection{3.1.1.10}
All flight software is developed to first meet system requirements. The system requirements outline what functionality will be required from the software as well as what will be available to serve as sources of information. Another consideration that is taken during this phase of software development is the hardware that the software will be running on. As the development cycle gets into writing the software itself, the primary method of configuration management follows a traditional Agile development cycle with team meetings every week to address concerns and defects. The codebase itself is structured and modular in nature so making isolated changes to configure the software to a different hardware or mission spec is controlled and reversible if need be.

Version control is also used to maintain both productivity and preserve proper versioning of the codebase once large sets of requirements are successfully encompassed and have passed testing. For testing and building release versions of the software, all merge requests must be approved by at least 1 other engineer to preserve main version branch functionality and which requirements each version completes will be documented in the repository itself. Verification and validation processes happen under formal testing conditions when hardware is readily available to run simulated mission conditions and ensure the checklist of requirements is fulfilled. 

\subsection{3.1.1.11}
N/A - the single board design of the KREPE module is designed such that complicated transmission and reception lines between devices, e.g. 1553  busses, are not necessary.

\subsection{3.1.1.12}
N/A - KREPE has no requirement for audio communication. KREPE has no uplink capability, therefore unauthorized third party control is not possible for KREPE.

\subsection{3.1.1.13}
N/A - KREPE does not receive any commands.


%\bibliographystyle{plain}
%\bibliography{references}
\end{document}
